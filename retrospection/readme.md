# 微服务改造

巨石转向微服务从不是一蹴而就的过程，在没有自动化测试保证的情况，贸然抽离现有的模块，是非常容易造成事故的。另一方面，巨石结构的拆分不单单是编码方面的事情，如果合理划分模块，如果分配好成员之间的协作，都是影响微服务成败的原因。如果涉及的是公司项目，甚至必然会存在一些组织管理方面的问题（所以我不敢）。

按功能分层的项目结构，如所有 controller 都放在一个目录下的结构，正在逐渐被业界抛弃。尤其是 2010 年代语言基本都自带现代化的依赖管理工具，不管是按模块划分，或者 monorepo 的形式都可以轻松处理。这种方式可以极大程度上杜绝，由于开发者的疏忽或一些非技术因素带来的，多模块之间不必要耦合的问题。真正划分模块中的另一个问题是，现有的方法，通常是基于实现编码，而非基于抽象编码，给模块分离的工程带来了不少前期工作。又或者说，补全自动化测试，完善模块实践，本来就是微服务改造的重要工作之一。

网络的不可靠性是维护微服务过程中绕不开的问题，通常 rpc 框架会帮我们处理好这些问题。gRPC 的优势之一，它足够标准化。但是性能恰恰是原项目中最为敏感的指标之一，所以使用 gRPC 的意义反而没那么大。另外得益于 Golang 优秀的并发控制机制，使用 errgroup 控制并发成为了基操之一。singleflight 等策略可以使得资源占用大大降低。

一个成熟的生产服务，至少应该有最基本的监控。因为实际使用的 web 框架以 gin 为主，所以基础版的 prometheus 中间件是基于 https://github.com/penglongli/gin-metrics，进行了一些定制化开发。同样 Grafana 面板参考了其实现，同时更进一步补充了业务上的一些指标。之后会考虑引入 jaeger 对全链路数据做观测。

缓存方面也对 write back 机制进行了实践，一定程度上解决了之前业务逻辑更新有可能导致缓存雪崩的问题，让生产环境中逻辑修改和功能变更可以 with confidence。
